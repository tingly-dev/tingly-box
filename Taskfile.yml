# https://taskfile.dev

version: '3'

includes:
  common: ./build/Taskfile.yml
  windows: ./build/windows/Taskfile.yml
  darwin: ./build/darwin/Taskfile.yml
  linux: ./build/linux/Taskfile.yml

vars:
  VERSION: ""
  BUILD_DIR: build
  DIST_DIR: build/dist
  
  PACKAGE_PATH: ./internal/wails3
  
  PORT: 12580
  
  APP_NAME: "TinglyBox"
  BIN_NAME: "tingly-box"
  BIN_DIR: "bin"
  VITE_PORT: '{{.WAILS_VITE_PORT | default 9245}}'

tasks:
  wails:build:
    summary: Builds the application
    cmds:
      - task: codegen
      - task: "{{OS}}:build"
  
  wails:package:
    summary: Packages a production build of the application
    cmds:
      - task: codegen
      - task: "{{OS}}:package"
  
  wails:run:
    summary: Runs the application
    cmds:
      - task: codegen
      - task: "{{OS}}:run"
  
  wails:dev:
    summary: Runs the application in development mode
    cmds:
      - task: codegen
      - wails3 dev -config ./build/config.yml -port {{.VITE_PORT}}
  
  wails:binding:
    cmds:
      - wails3 generate bindings -ts -f '-buildvcs=false -gcflags=all="-l"' -clean=true ./internal/wails3 -d frontend/src/bindings
  
  wails:manual:
    cmds:
      - cd frontend; pnpm build:dev:wails
      - |
        mkdir -p internal/gui/dist/
        cp -R frontend/dist/* internal/gui/dist/
      - |
        # Get build info
        VERSION="dev"
        GIT_COMMIT="$(git rev-parse HEAD 2>/dev/null || echo 'unknown')"
        GO_VERSION="$(go version | awk '{print $3}' | sed 's/go//' 2>/dev/null || echo 'unknown')"
        PLATFORM="$(go env GOOS)/$(go env GOARCH)"

        # Build with ldflags
        LDFLAGS='-X main.version=${VERSION} -X main.gitCommit=${GIT_COMMIT} -X main.buildTime=${BUILD_TIME} -X main.goVersion=${GO_VERSION} -X main.platform=${PLATFORM} -w -s'
        go build -tags debug -trimpath -buildvcs=false -ldflags="${LDFLAGS}" -o bin/{{.BIN_NAME}} {{.PACKAGE_PATH}}
        mkdir -p bin/{{.APP_NAME}}.app/Contents/{MacOS,Resources}
        cp build/darwin/icons.icns bin/{{.APP_NAME}}.app/Contents/Resources
        cp bin/{{.BIN_NAME}} bin/{{.APP_NAME}}.app/Contents/MacOS
        cp build/darwin/Info.plist bin/{{.APP_NAME}}.app/Contents
        codesign --force --deep --sign - bin/{{.APP_NAME}}.app
  
  codegen:
    cmds:
      - |
        echo install openapi-generator
        echo darwin: brew install openapi-generator
        echo others: npm install @openapitools/openapi-generator-cli -g
        echo ref: https://openapi-generator.tech/docs/installation
      - |
        openapi-generator-cli generate -g typescript-axios -i ./swagger.json -o ./frontend/src/client
  
  swagger:
    cmds:
      - |
        curl -s http://localhost:{{.PORT}}/swagger.json > swagger.json
  
  http:
    aliases:
      - start
    cmds:
      - task: go:build
      - ./build/{{.BIN_NAME}} --verbose start --debug
    
  https:
    cmds:
      - task: go:build
      - ./build/{{.BIN_NAME}} --verbose start --https
  
  cli:build:
    cmds:
      - task: web:dist
      - task: go:build
  
  go:build:
    env:
      ARCH:
      OS:
    cmds:
      - |
        # Get build info
        VERSION="dev"
        GIT_COMMIT="$(git rev-parse HEAD 2>/dev/null || echo 'unknown')"
        BUILD_TIME="$(date -u '+%Y-%m-%d-%H-%M-%S' 2>/dev/null || echo 'unknown')"
        GO_VERSION="$(go version | awk '{print $3}' | sed 's/go//' 2>/dev/null || echo 'unknown')"
        PLATFORM="${OS}/${ARCH}"

        # Build with ldflags
        mkdir -p build
        LDFLAGS="-X main.version=${VERSION} -X main.gitCommit=${GIT_COMMIT} -X main.buildTime=${BUILD_TIME} -X main.goVersion=${GO_VERSION} -X main.platform=${PLATFORM}"
        GOOS={{.OS}} GOARCH={{.ARCH}} go build -ldflags="${LDFLAGS}" -o ./build/{{.BIN_NAME}} ./internal/cmd/tingly-box
  
  go:test:
    cmds:
      - |
        go test ./internal/...
  
  cli:dev:
    cmds:
      - task: web:dist
      - |
        go run ./internal/cmd/tingly-box start
  
  web:dev:
    cmds:
      - |
        cd frontend; pnpm dev
  
  web:dist:
    cmds:
      - task: codegen
      - |
        cd frontend;
        if [ "$CI" = "true" ]; then
          pnpm install --no-frozen-lockfile;
        else
          pnpm install;
        fi;
        pnpm build
      - |
        mkdir -p internal/web/dist/
        cp -R frontend/dist/* internal/web/dist/

  web:dist-dev:
    cmds:
      - task: codegen
      - |
        cd frontend;
        if [ "$CI" = "true" ]; then
          pnpm install --no-frozen-lockfile;
        else
          pnpm install;
        fi;
        pnpm build:dev
      - |
        mkdir -p internal/web/dist/
        cp -R frontend/dist/* internal/web/dist/
  
  gui:build:
    cmds:
      - |
        go build -buildvcs=false -gcflags=all="-l" -o bin/{{.BIN_NAME}} ./wails3

  windows:build:amd64:
    summary: Cross-compiles for Windows AMD64 with CGO enabled (requires mingw-w64)
    cmds:
      - task: windows:build:cross:amd64
#  brew install zig
  windows:build:arm64:
    summary: Cross-compiles for Windows ARM64 with CGO (requires manual setup, see task output)
    cmds:
      - task: windows:build:cross:arm64

  # CLI build tasks for Windows (uses zig for cross-compilation with CGO)
  windows:cli:build:amd64:
    summary: Cross-compiles CLI for Windows AMD64 (requires zig)
    cmds:
      - task: windows:cli:build:cross:amd64

  windows:cli:build:arm64:
    summary: Cross-compiles CLI for Windows ARM64 (requires zig)
    cmds:
      - task: windows:cli:build:cross:arm64

  windows:cli:build:cross:amd64:
    summary: Cross-compiles CLI for Windows AMD64 with zig
    deps:
      - task: check:zig
    cmds:
      - |
        mkdir -p {{.BIN_DIR}}
        # Use zig as cross-compiler for Windows AMD64
        CC="zig cc -target x86_64-windows-gnu" \
        CXX="zig c++ -target x86_64-windows-gnu" \
        GOOS=windows GOARCH=amd64 CGO_ENABLED=1 \
        go build -buildvcs=false -ldflags="-w -s" -o {{.BIN_DIR}}/{{.BIN_NAME}}-amd64.exe ./internal/cmd/tingly-box

  windows:cli:build:cross:arm64:
    summary: Cross-compiles CLI for Windows ARM64 with zig
    deps:
      - task: check:zig
    cmds:
      - |
        mkdir -p {{.BIN_DIR}}
        # Use zig as cross-compiler for Windows ARM64
        CC="zig cc -target aarch64-windows-gnu" \
        CXX="zig c++ -target aarch64-windows-gnu" \
        GOOS=windows GOARCH=arm64 CGO_ENABLED=1 \
        go build -buildvcs=false -ldflags="-w -s" -o {{.BIN_DIR}}/{{.BIN_NAME}}-arm64.exe ./internal/cmd/tingly-box

  check:zig:
    summary: Check if zig is installed
    cmds:
      - |
        if ! command -v zig &> /dev/null; then
          echo "Error: zig not found!"
          echo ""
          echo "To install zig:"
          echo "  macOS:   brew install zig"
          echo "  Or download from: https://ziglang.org/download/"
          echo ""
          exit 1
        fi
        echo "Found: $(zig version)"
  