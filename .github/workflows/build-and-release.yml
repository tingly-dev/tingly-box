name: Build and Release

on:
  push:
    tags:
      - 'v*'
  # pull_request:
  #   branches: [ main ]
  workflow_dispatch:
    inputs:
      createRelease:
        description: 'Create GitHub Release'
        required: false
        default: false
        type: boolean
      releaseVersion:
        description: 'Release version (e.g., v1.0.0)'
        required: false
        type: string
      commitToReleaseRepo:
        description: 'Commit packages to tingly-dev/tingly-box-release repository'
        required: false
        default: true
        type: boolean

env:
  GO_VERSION: '1.25'
  NODE_VERSION: '20'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile
        working-directory: ./frontend

      - name: Install openapi-generator-cli
        run: npm install -g @openapitools/openapi-generator-cli

      - name: Build frontend and run codegen
        run: |
          openapi-generator-cli generate -g typescript-axios -i ../swagger.json -o ./src/client
          pnpm build && mkdir -p ../internal/server/web/dist && cp -R dist/* ../internal/server/web/dist/
        working-directory: ./frontend

      - name: Build Go binaries
        run: |
          # Create build directory
          mkdir -p dist

          # Build Linux binaries
          GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o ./dist/tingly-box-linux-amd64 ./cmd/tingly-box
          GOOS=linux GOARCH=arm64 go build -ldflags="-s -w" -o ./dist/tingly-box-linux-arm64 ./cmd/tingly-box

          # Build macOS binaries
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o ./dist/tingly-box-macos-amd64 ./cmd/tingly-box
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o ./dist/tingly-box-macos-arm64 ./cmd/tingly-box

          # Build Windows binaries
          GOOS=windows GOARCH=amd64 go build -ldflags="-s -w" -o ./dist/tingly-box-windows-amd64.exe ./cmd/tingly-box
          # GOOS=windows GOARCH=arm64 go build -ldflags="-s -w" -o ./dist/tingly-box-windows-arm64.exe ./cmd/tingly-box

          # Make Linux binaries executable
          chmod +x ./dist/tingly-box-linux-*
          chmod +x ./dist/tingly-box-macos-*

      # - name: Upload build artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: binaries
      #     path: ./dist/
      #     retention-days: 7
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Setup SSH for GitHub
        env:
          SSH_PRIVATE_KEY: ${{ secrets.RELEASE_REPO_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          # Test SSH connectivity
          echo "Testing SSH connectivity..."
          ssh -i ~/.ssh/id_ed25519 -T git@github.com || echo "SSH connection test completed"
          
      - name: Set branch name and version
        id: branch-info
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.releaseVersion }}" ]; then
            VERSION="${{ github.event.inputs.releaseVersion }}"
            BRANCH_SUFFIX="${VERSION}"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BRANCH_SUFFIX="manual-$(date +%Y%m%d-%H%M%S)"
          else
            # Extract version from tag
            VERSION=${GITHUB_REF#refs/tags/}
            BRANCH_SUFFIX="v${VERSION}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "branch_suffix=$BRANCH_SUFFIX" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_SUFFIX" >> $GITHUB_OUTPUT
      
      - name: Commit and push packages to release repository
        env:
          VERSION: ${{ steps.branch-info.outputs.version }}
        run: |
          # Make script executable
          chmod +x .github/workflows/scripts/commit-packages-to-branch.sh

          # Run the commit script with the repository name instead of full SSH URL
          # The script will handle the SSH URL construction
          .github/workflows/scripts/commit-packages-to-branch.sh "${{ steps.branch-info.outputs.branch_suffix }}" "tingly-dev/tingly-box-release"
      
      - name: List created branch
        run: |
          echo "âœ… Created branch: ${{ steps.branch-info.outputs.branch_name }}"
          echo "ðŸ“¦ Packages are available in:"
          echo "  - https://github.com/tingly-dev/tingly-box-release/tree/${{ steps.branch-info.outputs.branch_name }}/"

      - name: Update LATEST.json in main branch
        env:
          BRANCH_NAME: ${{ steps.branch-info.outputs.branch_name }}
        run: |
          # Make script executable
          chmod +x .github/workflows/scripts/update-latest-json.sh

          # Run the update script
          .github/workflows/scripts/update-latest-json.sh "${{ github.sha }}" "$BRANCH_NAME" "tingly-dev/tingly-box-release"
      
  # create-packages:
  #   needs: build
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     matrix:
  #       include:
  #         - os: ubuntu-latest
  #           platform: linux-amd64
  #           package: tar.gz
  #         # - os: ubuntu-latest
  #         #   platform: linux-arm64
  #         #   package: tar.gz
  #         - os: macos-latest
  #           platform: macos-amd64
  #           package: zip
  #         - os: macos-latest
  #           platform: macos-arm64
  #           package: zip
  #         - os: windows-latest
  #           platform: windows-amd64
  #           package: zip
  #         # - os: windows-latest
  #         #   platform: windows-arm64
  #         #   package: zip
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: binaries
  #         path: ./build
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #
  #     - name: Create Linux package
  #       if: matrix.platform == 'linux-amd64' || matrix.platform == 'linux-arm64'
  #       run: |
  #         PLATFORM=${{ matrix.platform }}
  #         ARCHIVE_NAME="tingly-${PLATFORM}"
  #         mkdir -p dist/$ARCHIVE_NAME
  #         cp ./dist/tingly-box-$PLATFORM dist/$ARCHIVE_NAME/tingly-box
  #         chmod +x dist/$ARCHIVE_NAME/tingly-box
  #
  #         # Create a simple install script
  #         cat > dist/$ARCHIVE_NAME/install.sh << 'EOF'
  #         #!/bin/bash
  #         set -e
  #         INSTALL_DIR="/usr/local/bin"
  #         echo "Installing Tingly to $INSTALL_DIR..."
  #         sudo cp tingly $INSTALL_DIR/
  #         sudo chmod +x $INSTALL_DIR/tingly-box
  #         echo "Tingly installed successfully!"
  #         tingly --version
  #         EOF
  #         chmod +x dist/$ARCHIVE_NAME/install.sh
  #
  #         # Create tar.gz package with maximum compression
  #         cd dist
  #         tar -czf $ARCHIVE_NAME.tar.gz $ARCHIVE_NAME/
  #
  #     - name: Create macOS package (zip)
  #       if: matrix.platform == 'macos-amd64' || matrix.platform == 'macos-arm64'
  #       run: |
  #         PLATFORM=${{ matrix.platform }}
  #         ARCHIVE_NAME="tingly-${PLATFORM}"
  #         mkdir -p dist/$ARCHIVE_NAME
  #         cp ./dist/tingly-box-$PLATFORM dist/$ARCHIVE_NAME/tingly-box
  #         chmod +x dist/$ARCHIVE_NAME/tingly-box
  #
  #         # Create Info.plist for macOS
  #         cat > dist/$ARCHIVE_NAME/Info.plist << 'EOF'
  #         <?xml version="1.0" encoding="UTF-8"?>
  #         <plist version="1.0">
  #         <dict>
  #           <key>CFBundleExecutable</key>
  #           <string>tingly</string>
  #           <key>CFBundleIdentifier</key>
  #           <string>com.tingly.box</string>
  #           <key>CFBundleName</key>
  #           <string>Tingly</string>
  #           <key>CFBundleVersion</key>
  #           <string>1.0</string>
  #           <key>CFBundleShortVersionString</key>
  #           <string>1.0</string>
  #         </dict>
  #         </plist>
  #         EOF
  #
  #         # Create install script
  #         cat > dist/$ARCHIVE_NAME/install.sh << 'EOF'
  #         #!/bin/bash
  #         set -e
  #         INSTALL_DIR="/usr/local/bin"
  #         echo "Installing Tingly to $INSTALL_DIR..."
  #         sudo cp tingly $INSTALL_DIR/
  #         sudo chmod +x $INSTALL_DIR/tingly-box
  #         # Remove macOS quarantine attribute to prevent security warnings
  #         sudo xattr -d com.apple.quarantine $INSTALL_DIR/tingly-box 2>/dev/null || true
  #         echo "Tingly installed successfully!"
  #         tingly --version
  #         EOF
  #         chmod +x dist/$ARCHIVE_NAME/install.sh
  #
  #         # Create zip package
  #         cd dist
  #         zip -r $ARCHIVE_NAME.zip $ARCHIVE_NAME/ -x "*.DS_Store"
  #
  #     - name: Create Windows package (zip)
  #       if: matrix.platform == 'windows-amd64' || matrix.platform == 'windows-arm64'
  #       shell: powershell
  #       run: |
  #         $PLATFORM = "${{ matrix.platform }}"
  #         $ARCHIVE_NAME = "tingly-$PLATFORM"
  #         New-Item -ItemType Directory -Path "dist/$ARCHIVE_NAME" -Force
  #         Copy-Item "./dist/tingly-box-$PLATFORM.exe" "dist/$ARCHIVE_NAME/tingly-box.exe"
  #
  #         # Create batch install script using PowerShell here-string
  #         $installScript = @"
  #         @echo off
  #         echo Installing Tingly...
  #         set INSTALL_DIR=C:\Program Files\Tingly
  #         if not exist "%INSTALL_DIR%" mkdir "%INSTALL_DIR%"
  #         copy tingly.exe "%INSTALL_DIR%\" >nul
  #         set PATH=%PATH%;%INSTALL_DIR%
  #         echo Tingly installed to %INSTALL_DIR%
  #         echo Run: tingly --version
  #         pause
  #         "@
  #         $installScript | Out-File -FilePath "dist\$ARCHIVE_NAME\install.bat" -Encoding ASCII
  #
  #         # Create README for Windows
  #         $readme = @"
  #         Tingly Box - AI Provider Management CLI
  #
  #         Installation:
  #         1. Run install.bat as Administrator
  #         2. Or manually copy tingly.exe to your desired location
  #
  #         Usage:
  #           tingly --version
  #           tingly start
  #         "@
  #         $readme | Out-File -FilePath "dist\$ARCHIVE_NAME\README.txt" -Encoding ASCII
  #
  #         # Create zip package using PowerShell Compress-Archive
  #         Compress-Archive -Path "dist\$ARCHIVE_NAME\*" -DestinationPath "dist\$ARCHIVE_NAME.zip" -Force
  #
  #     - name: Upload packages
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: packages-${{ matrix.platform }}
  #         path: ./dist/
  #         retention-days: 30

  # release:
  #   # needs: [create-packages, create-npm-distribution]
  #   needs: [create-packages]
  #   runs-on: ubuntu-latest
  #   if: |
  #     startsWith(github.ref, 'refs/tags/v') ||
  #     (github.event_name == 'workflow_dispatch' && github.event.inputs.createRelease == 'true' && startsWith(github.ref, 'refs/tags/'))
  #   permissions:
  #     contents: write
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #
  #     - name: Download all artifacts
  #       uses: actions/download-artifact@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #
  #     - name: Create release directory
  #       run: |
  #         mkdir -p release
  #         mv packages-*/* release/ 2>/dev/null || true
  #
  #     - name: Create checksums
  #       run: |
  #         cd release
  #         sha256sum *.* > checksums.txt 2>/dev/null || true
  #
  #     - name: Generate changelog
  #       run: |
  #         # Extract version from tag or input
  #         if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.releaseVersion }}" ]; then
  #           VERSION="${{ github.event.inputs.releaseVersion }}"
  #         else
  #           VERSION=${GITHUB_REF#refs/tags/}
  #         fi
  #         echo "## Changes in version $VERSION" > release-notes.md
  #
  #         # Get commits since last tag
  #         git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> release-notes.md 2>/dev/null || echo "- Initial release" >> release-notes.md
  #
  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v2
  #       with:
  #         files: release/*
  #         body_path: release-notes.md
  #         draft: false
  #         prerelease: false
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # commit-packages-to-release-repo:
  #   runs-on: ubuntu-latest
  #   needs: build
  #   # if: |
  #   #   always() && needs.build.result == 'success' &&
  #   #   (github.event_name == 'workflow_dispatch' && github.event.inputs.commitToReleaseRepo == 'true') ||
  #   #   startsWith(github.ref, 'refs/tags/v')
  #   permissions:
  #     contents: write
  #     packages: read
  #   steps:
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}
  #
  #     - name: Configure Git
  #       run: |
  #         git config --global user.name "github-actions[bot]"
  #         git config --global user.email "github-actions[bot]@users.noreply.github.com"
  #
  #     - name: Setup SSH for GitHub
  #       env:
  #         SSH_PRIVATE_KEY: ${{ secrets.RELEASE_REPO_SSH_KEY }}
  #       run: |
  #         mkdir -p ~/.ssh
  #         echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
  #         chmod 600 ~/.ssh/id_ed25519
  #         ssh-keyscan github.com >> ~/.ssh/known_hosts
  #         chmod 644 ~/.ssh/known_hosts
  #         # Test SSH connection
  #         ssh -T git@github.com || true
  #
  #     - name: Download artifacts from build job
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: binaries
  #         path: ./dist
  #
  #     - name: Set branch name and version
  #       id: branch-info
  #       run: |
  #         if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.releaseVersion }}" ]; then
  #           VERSION="${{ github.event.inputs.releaseVersion }}"
  #           BRANCH_SUFFIX="v${VERSION}"
  #         elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
  #           BRANCH_SUFFIX="manual-$(date +%Y%m%d-%H%M%S)"
  #         else
  #           # Extract version from tag
  #           VERSION=${GITHUB_REF#refs/tags/}
  #           BRANCH_SUFFIX="v${VERSION}"
  #         fi
  #
  #         echo "version=$VERSION" >> $GITHUB_OUTPUT
  #         echo "branch_suffix=$BRANCH_SUFFIX" >> $GITHUB_OUTPUT
  #         echo "branch_name=packages-$BRANCH_SUFFIX" >> $GITHUB_OUTPUT
  #
  #     - name: Commit and push packages to release repository
  #       env:
  #         VERSION: ${{ steps.branch-info.outputs.version }}
  #       run: |
  #         # Make script executable
  #         chmod +x .github/workflows/scripts/commit-packages-to-branch.sh
  #
  #         # Run the commit script
  #         .github/workflows/scripts/commit-packages-to-branch.sh "packages-${{ steps.branch-info.outputs.branch_suffix }}" "tingly-dev/tingly-box-release"
  #
  #     - name: List created branch
  #       run: |
  #         echo "âœ… Created branch: ${{ steps.branch-info.outputs.branch_name }}"
  #         echo "ðŸ“¦ Packages are available in:"
  #         echo "  - https://github.com/tingly-dev/tingly-box-release/tree/${{ steps.branch-info.outputs.branch_name }}/"