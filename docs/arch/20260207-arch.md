# Tingly Box Architecture Documentation

**Generated:** 2026-02-07
**Project:** tingly-box - API Gateway for LLM Services

## Project Overview

Tingly Box is a unified API gateway for multiple LLM providers (OpenAI, Anthropic, Google) with smart routing, load balancing, and context compression capabilities.

## Technology Stack

### Backend
- **Language:** Go 1.25.3
- **Framework:** Gin (github.com/gin-gonic/gin)
- **Database:** SQLite with GORM
- **Authentication:** JWT (github.com/golang-jwt/jwt/v5)
- **Logging:** Logrus

### Frontend
- **Framework:** React 19.2.3 with TypeScript
- **Build Tool:** Vite 7.3.0
- **UI Library:** Material-UI (MUI) v7.3.6
- **Routing:** React Router DOM v7.11.0
- **HTTP Client:** Axios + OpenAPI-generated client

## Directory Structure

```
/root/tingly-box/
├── build/           # Build scripts
├── cli/             # CLI tool
├── cmd/             # Command implementations
├── docs/            # Documentation
├── frontend/        # React web UI
├── gui/             # GUI (Wails3)
├── internal/
│   ├── client/      # LLM client implementations
│   ├── command/     # Command handling
│   ├── config/      # Configuration management
│   ├── constant/    # Constants
│   ├── data/        # Data models and managers
│   │   └── db/      # Database stores (SQLite/GORM)
│   ├── loadbalance/ # Load balancing tactics
│   ├── obs/         # Observability (logging, metrics)
│   ├── protocol/    # API protocol handlers
│   ├── server/      # HTTP server and routes
│   │   ├── middleware/  # Auth, CORS, logging
│   │   └── config/      # Server config
│   ├── smart_routing/ # Smart routing logic
│   ├── typ/         # Type definitions
│   └── web/         # Web UI integration
├── libs/            # External library submodules
└── pkg/             # Public packages
    ├── auth/        # JWT authentication
    ├── benchmark/   # Benchmarking utilities
    ├── daemon/      # Daemon service management
    ├── fs/          # File system utilities
    ├── lock/        # Locking mechanisms
    ├── network/     # Network utilities
    ├── oauth/       # OAuth implementation
    └── swagger/     # OpenAPI/Swagger generation
```

## Database Schema

**Database Location:** `~/.tingly-box/db/tingly.db`

### Tables

1. **provider_models** - Provider model listings
2. **usage_records** - Individual usage tracking
3. **usage_daily** - Daily aggregated stats
4. **usage_monthly** - Monthly aggregated stats
5. **model_capabilities** - Model endpoint capabilities
6. **rule_service_index** - Current service selection for rules
7. **service_stats** - Service usage statistics

## Authentication System

### Current Implementation

**Single-Token System:**
- **User Token** (`user_token`): For UI and control API authentication
- **Model Token** (`model_token`): For OpenAI/Anthropic API authentication

**JWT Manager** (`pkg/auth/jwt.go`):
- Generates JWT tokens with configurable expiry (default 24 hours)
- API Key format: `tingly-box-{base64_encoded_jwt}`
- Claims: `{client_id, exp, iat}`

**Authentication Middleware** (`internal/server/middleware/auth.go`):
- `UserAuthMiddleware()`: Validates user token for management APIs
- `ModelAuthMiddleware()`: Validates model token for LLM APIs
- Supports both `Authorization: Bearer <token>` and `X-Api-Key` headers

### Current Limitations

- Single-user model (no multi-user support)
- No role-based access control
- No admin/user distinction
- Tokens stored in plain config.json
- No token revocation mechanism

## Configuration System

**Config File:** `~/.tingly-box/config.json`

**Key Configuration Structures:**

```go
type Config struct {
    Rules            []typ.Rule           // Request configurations
    UserToken        string               // User auth token
    ModelToken       string               // Model auth token
    Providers        []*typ.Provider      // Provider configurations
    Scenarios        []typ.ScenarioConfig // Scenario-specific configs
    GUI              GUIConfig            // GUI settings
    ServerPort       int
    JWTSecret        string
    DefaultMaxTokens int
    Verbose          bool
    Debug            bool
    OpenBrowser      bool
}
```

## API Endpoints

### AI Model API (requires model token)
- `/openai/v1/chat/completions`
- `/openai/v1/models`
- `/anthropic/v1/messages`
- `/anthropic/v1/messages/count_tokens`
- `/tingly/:scenario/*`

### Management API (requires user token)
- `/api/v1/info/*` - Server info, health, version
- `/api/v1/log/*` - Log management
- `/api/v1/providers` - Provider CRUD
- `/api/v1/rules` - Rule management
- `/api/v1/scenarios` - Scenario configuration
- `/api/v1/usage/*` - Usage statistics
- `/api/v1/token` - Token generation

## Frontend Structure

**Pages:** (`frontend/src/pages/`)
- DashboardPage.tsx - Main dashboard
- CredentialPage.tsx - Credential management
- ApiKeyPage.tsx - API key management
- OAuthPage.tsx - OAuth provider management
- System.tsx - System settings
- ModelTestPage.tsx - Model testing
- Login.tsx - Authentication

**Contexts:**
- AuthContext - Authentication state
- HealthContext - Server health monitoring
- VersionContext - Version checking
- FeatureFlagsContext - Feature flag management
- ModelSelectContext - Model selection

## Key Design Patterns

1. **Middleware Chain:** Authentication → CORS → Logging → Handler
2. **Load Balancing:** Round Robin, Token-Based, Hybrid, Random tactics
3. **Smart Routing:** Scenario-based routing with fallback
4. **Configuration Watcher:** Hot reload without restart
5. **Context Management:** React Context for global state

## Extension Points

For Enterprise Edition, key areas to extend:

1. **Authentication:** Multi-user support, RBAC, session management
2. **Database:** New tables for users, tokens, audit logs
3. **API:** Admin endpoints for user/token management
4. **Frontend:** Login flow, user profile, admin panel
5. **Configuration:** Enterprise feature flags
